<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Dashboard | Geofence Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f1b; }
        .dashboard-card { background-color: #1a1a2e; border: 1px solid rgba(128, 0, 128, 0.2); box-shadow: 0 8px 32px 0 rgba(147, 51, 234, 0.1); }
        #map { height: 100%; width: 100%; border-radius: 1rem; border: 1px solid rgba(128, 0, 128, 0.3); min-height: 400px; }
        .custom-btn { background: linear-gradient(90deg, #8e2de2, #4a00e0); transition: all 0.3s ease; }
        .custom-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4); }
        .battery-bar { transition: width 0.5s ease-in-out; }
        .modal-enter { opacity: 0; pointer-events: none; transform: scale(0.95); transition: all 0.3s ease; }
        .modal-active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .input-error { border-color: #ef4444 !important; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="text-gray-200">

    <div class="min-h-screen flex">
        <aside class="w-64 bg-[#1a1a2e] p-6 hidden lg:flex flex-col justify-between border-r border-purple-800/20">
            <div>
                <h1 class="text-2xl font-bold text-white mb-10 italic">ParentPortal</h1>
                <nav class="space-y-4">
                    <a href="#" class="flex items-center space-x-3 text-purple-400 bg-purple-900/20 p-3 rounded-lg"><i data-feather="map"></i><span>NexusGuard Map</span></a>
                    <a href="#" class="flex items-center space-x-3 text-gray-400 p-3 rounded-lg hover:text-white"><i data-feather="settings"></i><span>Settings</span></a>
                </nav>
            </div>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-10 relative overflow-hidden">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">Parent Dashboard</h2>
                    <p class="text-gray-400 mt-1">Live tracking and geofence monitoring.</p>
                </div>
                 <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <div class="relative group cursor-pointer" id="profile-trigger">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full opacity-75 blur-[2px]"></div>
                        <img src="https://placehold.co/40x40/4a00e0/white?text=P" alt="Profile" class="relative w-10 h-10 rounded-full border-2 border-[#1a1a2e]">
                        <div class="absolute -bottom-1 -right-1 bg-gray-500 w-3 h-3 rounded-full border-2 border-[#1a1a2e]" id="connection-status-dot"></div>
                    </div>
                </div>
            </header>

            <div id="empty-state" class="flex flex-col items-center justify-center h-[60vh] text-center p-6">
                <div class="w-24 h-24 bg-[#1a1a2e] border-2 border-dashed border-purple-500/30 rounded-full flex items-center justify-center mb-6">
                    <i data-feather="user-plus" class="text-purple-400 w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">No Student Connected</h3>
                <p class="text-gray-400 max-w-md mb-8">Enter the unique student ID (1234) to begin monitoring.</p>
                <button id="main-connect-btn" class="custom-btn text-white font-bold py-3 px-8 rounded-xl flex items-center space-x-2">
                    <i data-feather="link"></i><span>Connect Student</span>
                </button>
            </div>

            <div id="dashboard-content" class="hidden grid grid-cols-1 xl:grid-cols-3 gap-8 h-full">
                <div class="xl:col-span-1 flex flex-col gap-8">
                    <div class="dashboard-card rounded-2xl p-6">
                        <div class="flex items-center space-x-4 mb-6">
                             <img src="https://placehold.co/64x64/8e2de2/white?text=A" class="w-16 h-16 rounded-full border-2 border-purple-400">
                             <div>
                                <p class="text-lg font-bold text-white">Archean Alcantara</p>
                                <p id="location-status" class="text-sm font-medium text-green-400 tracking-wide">‚óè Tracking Active</p>
                             </div>
                        </div>
                        <div class="mt-6 border-t border-purple-800/20 pt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-gray-400 uppercase tracking-widest">Battery Level</span>
                                <span id="battery-level" class="text-sm font-bold text-white">--%</span>
                            </div>
                            <div class="w-full bg-[#2c2c54] rounded-full h-1.5">
                                <div id="battery-bar" class="battery-bar h-1.5 rounded-full bg-green-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card rounded-2xl p-6">
                         <h3 class="text-xl font-semibold text-white mb-2">Geofence Controls</h3>
                         <p class="text-gray-400 text-xs mb-4">Draw a boundary. You will be alerted if the student enters or exits the area.</p>
                         <div class="flex space-x-3">
                            <button id="draw-btn" class="flex-1 custom-btn text-white text-xs font-bold py-3 rounded-lg flex items-center justify-center space-x-1">
                                <i data-feather="plus-circle" class="w-4 h-4"></i><span>Draw Fence</span>
                            </button>
                            <button id="clear-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-3 rounded-lg flex items-center justify-center space-x-1 transition">
                                <i data-feather="trash-2" class="w-4 h-4"></i><span>Clear</span>
                            </button>
                         </div>
                    </div>

                    <div class="dashboard-card rounded-2xl p-6">
                         <h3 class="text-xl font-semibold text-white mb-4">Recent Alerts</h3>
                         <div id="alert-list" class="space-y-3 max-h-[200px] overflow-y-auto">
                            <p class="text-gray-500 text-xs italic text-center">No security alerts triggered.</p>
                         </div>
                    </div>
                </div>

                <div class="xl:col-span-2 dashboard-card rounded-2xl p-4 min-h-[500px]">
                    <div id="map"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="connect-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm modal-enter">
        <div class="bg-[#1a1a2e] border border-purple-500/30 w-full max-w-md p-8 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-4">Connect Student</h2>
            <input type="text" id="student-id-input" placeholder="Enter Student ID (1234)" class="w-full bg-[#0f0f1b] border border-gray-700 text-white rounded-xl px-4 py-3 mb-4 outline-none focus:border-purple-500">
            <p id="error-msg" class="text-red-400 text-xs mb-4 hidden">Invalid ID. Please try again.</p>
            <button id="connect-submit-btn" class="w-full custom-btn text-white font-bold py-3.5 rounded-xl">Connect Account</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

    <script>
        feather.replace();

        // 1. Firebase Config
        const firebaseConfig = { databaseURL: "https://student-tracker-c60b8-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 2. Global State
        let map, studentMarker, geofencePolygon = null;
        let lastGeofenceStatus = null; // 'inside' or 'outside'

        // 3. UI Controls
        const modal = document.getElementById('connect-modal');
        const connectSubmitBtn = document.getElementById('connect-submit-btn');
        const studentInput = document.getElementById('student-id-input');
        const dashboardContent = document.getElementById('dashboard-content');
        const emptyState = document.getElementById('empty-state');
        const statusDot = document.getElementById('connection-status-dot');
        const alertList = document.getElementById('alert-list');

        document.getElementById('main-connect-btn').onclick = () => modal.classList.add('modal-active');
        
        connectSubmitBtn.onclick = () => {
            if(studentInput.value.trim() === "1234") {
                modal.classList.remove('modal-active');
                emptyState.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                statusDot.classList.replace('bg-gray-500', 'bg-green-500');
                initMap();
                startTracking();
                addAlert("Connected to Archean's device.", "check-circle", "text-blue-400");
            } else {
                studentInput.classList.add('input-error');
                document.getElementById('error-msg').classList.remove('hidden');
            }
        };

        // 4. Map & Drawing Initialization
        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            studentMarker = L.marker([0,0]).addTo(map).bindPopup("<b>Archean Alcantara</b><br>Live");

            // Init Draw Tools
            const drawnItems = new L.FeatureGroup().addTo(map);
            const drawControl = new L.Control.Draw({
                draw: { polyline: false, circle: false, circlemarker: false, marker: false, rectangle: true, polygon: true },
                edit: { featureGroup: drawnItems, remove: true }
            });

            document.getElementById('draw-btn').onclick = () => {
                new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
            };

            document.getElementById('clear-btn').onclick = () => {
                drawnItems.clearLayers();
                geofencePolygon = null;
                lastGeofenceStatus = null;
            };

            map.on(L.Draw.Event.CREATED, (e) => {
                drawnItems.clearLayers();
                const layer = e.layer;
                drawnItems.addLayer(layer);
                geofencePolygon = layer.toGeoJSON();
                addAlert("New Geofence established.", "shield", "text-purple-400");
            });
        }

        // 5. Tracking & Geofence Logic
        function startTracking() {
            database.ref('tracking/Archean_Mobile').on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const { lat, lng, battery } = data;
                const studentPoint = [lat, lng];

                // Update UI
                studentMarker.setLatLng(studentPoint);
                map.panTo(studentPoint);
                document.getElementById('battery-level').innerText = battery + "%";
                document.getElementById('battery-bar').style.width = battery + "%";

                // Geofence Calculation
                if (geofencePolygon) {
                    const pt = turf.point([lng, lat]); // Turf uses [lng, lat]
                    const poly = turf.polygon(geofencePolygon.geometry.coordinates);
                    const isInside = turf.booleanPointInPolygon(pt, poly);
                    const currentStatus = isInside ? 'inside' : 'outside';

                    if (lastGeofenceStatus !== null && lastGeofenceStatus !== currentStatus) {
                        if (currentStatus === 'inside') {
                            addAlert("Archean ENTERED the safe zone.", "log-in", "text-green-400");
                        } else {
                            addAlert("Archean LEFT the safe zone!", "alert-triangle", "text-red-500");
                        }
                    }
                    lastGeofenceStatus = currentStatus;
                }
            });
        }

        // Helper to add alerts
        function addAlert(msg, icon, colorClass) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const alertHtml = `
                <div class="flex items-start space-x-3 p-2 bg-white/5 rounded-lg border border-white/10 animate-pulse">
                    <i data-feather="${icon}" class="${colorClass} w-4 h-4 mt-0.5"></i>
                    <div>
                        <p class="text-[11px] font-bold text-white uppercase">${msg}</p>
                        <p class="text-[9px] text-gray-500">${time}</p>
                    </div>
                </div>
            `;
            if (alertList.querySelector('p')) alertList.innerHTML = '';
            alertList.insertAdjacentHTML('afterbegin', alertHtml);
            feather.replace();
        }
    </script>
</body>
</html>
